<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.kalpa.olivia.repository.FileboxRepository">
   <insert id="addFolder" parameterType="Filebox">
    /* add folder */
	INSERT INTO public.file_box
	(box_id, parent_id, folder_nm, note, create_on, create_by)
	VALUES
	(nextval('file_box_box_id_seq'::regclass), #{parentId}, #{folderNm}, #{note}, CURRENT_TIMESTAMP, #{createBy})    
   </insert>
   
   <select id="subFolderList" parameterType="Integer" resultType="Filebox">
		WITH RECURSIVE subfolders (box_id, parent_id, folder_nm, note, create_on, create_by, level, path, cycle) 
		AS(
		   SELECT f.box_id, f.parent_id, f.folder_nm, f.note,f.create_on, f.create_by, 0, ARRAY[f.box_id], false
		   FROM public.file_box f
		   WHERE f.parent_id = 0
		   UNION ALL
		   SELECT d.box_id, d.parent_id, d.folder_nm, d.note,d.create_on, d.create_by, level + 1, path || d.box_id, d.box_id = ANY(path)
		   FROM public.file_box d, subfolders s
		   WHERE d.parent_id = s.box_id
		   AND NOT CYCLE
		)
		SELECT box_id, parent_id, folder_nm, note, create_on, create_by, level, path 
		FROM subfolders
		--where parent_id = 1
		ORDER BY path
   </select>
</mapper>